---
// Fetch services from API
const API_URL = import.meta.env.PUBLIC_API_URL || 'http://localhost:3001/api';
let apiServices = [];

try {
  const response = await fetch(`${API_URL}/services`);
  const data = await response.json();
  if (data.success && data.data) {
    apiServices = data.data.map((service: any) => ({
      icon: service.icon || 'code',
      title: service.title,
      description: service.description,
      features: Array.isArray(service.features) ? service.features : [],
      color: service.color || 'cyan',
    }));
  }
} catch (error) {
  console.error('Error fetching services:', error);
}

// Fallback services
const fallbackServices = [
  {
    icon: 'code',
    title: 'Desarrollo Web',
    description: 'Sitios web modernos, rápidos y optimizados para SEO. Desde landing pages hasta plataformas complejas.',
    features: ['React / Next.js / Astro', 'E-commerce', 'CMS Personalizados', 'Progressive Web Apps'],
    color: 'cyan',
  },
  {
    icon: 'mobile',
    title: 'Apps Móviles',
    description: 'Aplicaciones nativas e híbridas para iOS y Android que destacan en las tiendas de aplicaciones.',
    features: ['React Native', 'Flutter', 'iOS Nativo', 'Android Nativo'],
    color: 'blue',
  },
  {
    icon: 'software',
    title: 'Software a Medida',
    description: 'Soluciones empresariales personalizadas: CRM, ERP, automatización y sistemas de gestión.',
    features: ['CRM / ERP', 'Automatización', 'Integraciones API', 'Dashboards'],
    color: 'dark-blue',
  },
  {
    icon: 'marketing',
    title: 'Marketing Digital',
    description: 'Estrategias de marketing que generan resultados: SEO, SEM, redes sociales y más.',
    features: ['SEO / SEM', 'Social Media', 'Email Marketing', 'Analytics'],
    color: 'cyan',
  },
  {
    icon: 'design',
    title: 'Diseño UX/UI',
    description: 'Interfaces intuitivas y atractivas que mejoran la experiencia del usuario y las conversiones.',
    features: ['Wireframes', 'Prototipos', 'Design Systems', 'User Research'],
    color: 'blue',
  },
  {
    icon: 'maintenance',
    title: 'Mantenimiento',
    description: 'Soporte continuo, actualizaciones de seguridad y optimización de rendimiento.',
    features: ['Hosting', 'Backups', 'Monitoreo 24/7', 'Actualizaciones'],
    color: 'dark-blue',
  },
];

// Use API services or fallback
const services = apiServices.length > 0 ? apiServices : fallbackServices;

const icons: Record<string, string> = {
  code: `<path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M10 20l4-16m4 4l4 4-4 4M6 16l-4-4 4-4" />`,
  mobile: `<path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M12 18h.01M8 21h8a2 2 0 002-2V5a2 2 0 00-2-2H8a2 2 0 00-2 2v14a2 2 0 002 2z" />`,
  software: `<path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />`,
  marketing: `<path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M11 3.055A9.001 9.001 0 1020.945 13H11V3.055z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M20.488 9H15V3.512A9.025 9.025 0 0120.488 9z" />`,
  design: `<path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M7 21a4 4 0 01-4-4V5a2 2 0 012-2h4a2 2 0 012 2v12a4 4 0 01-4 4zm0 0h12a2 2 0 002-2v-4a2 2 0 00-2-2h-2.343M11 7.343l1.657-1.657a2 2 0 012.828 0l2.829 2.829a2 2 0 010 2.828l-8.486 8.485M7 17h.01" />`,
  maintenance: `<path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />`,
};

const colorClasses: Record<string, { bg: string; border: string; text: string; glow: string }> = {
  cyan: {
    bg: 'bg-cyan-500/10',
    border: 'border-cyan-500/30',
    text: 'text-cyan-400',
    glow: 'group-hover:shadow-[0_0_30px_rgba(0,211,255,0.3)]',
  },
  blue: {
    bg: 'bg-blue-500/10',
    border: 'border-blue-500/30',
    text: 'text-blue-400',
    glow: 'group-hover:shadow-[0_0_30px_rgba(0,55,153,0.3)]',
  },
  'dark-blue': {
    bg: 'bg-dark-blue-500/20',
    border: 'border-dark-blue-400/30',
    text: 'text-white',
    glow: 'group-hover:shadow-[0_0_30px_rgba(1,24,61,0.4)]',
  },
};
---

<section id="servicios" class="py-12 sm:py-16 lg:py-20 bg-gray-200 relative overflow-hidden">
  <!-- Background Pattern -->
  <div class="absolute inset-0 bg-[linear-gradient(rgba(1,24,61,0.02)_1px,transparent_1px),linear-gradient(90deg,rgba(1,24,61,0.02)_1px,transparent_1px)] bg-[size:40px_40px]"></div>
  
  <div class="container mx-auto px-4 sm:px-6 lg:px-12 relative z-10">
    <!-- Section Header -->
    <div class="text-center max-w-3xl mx-auto mb-8 sm:mb-12 lg:mb-16">
      <div class="inline-flex items-center gap-2 px-3 py-1.5 sm:px-4 sm:py-2 rounded-full bg-dark-blue-500/5 border border-dark-blue-500/10 mb-4 sm:mb-6">
        <span class="w-1.5 h-1.5 sm:w-2 sm:h-2 bg-cyan-500 rounded-full"></span>
        <span class="text-dark-blue-500/70 text-xs sm:text-sm font-medium">Nuestros Servicios</span>
      </div>
      
      <h2 class="text-2xl sm:text-3xl md:text-4xl lg:text-5xl font-montserrat-alt font-light text-dark-blue-500 mb-3 sm:mb-6 leading-tight reveal">
        Soluciones digitales que
        <span class="gradient-text"> impulsan tu negocio</span>
      </h2>
      
      <p class="text-base sm:text-lg text-dark-blue-500/60 leading-relaxed reveal">
        Ofrecemos un portafolio completo de servicios tecnológicos diseñados para transformar tu presencia digital y maximizar tus resultados.
      </p>
    </div>

    <!-- Services Grid -->
    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-5 sm:gap-6 lg:gap-8" id="services-grid">
      <!-- Will be populated dynamically -->
    </div>

    <!-- CTA -->
    <div class="text-center mt-16">
      <a 
        href="/servicios" 
        class="inline-flex items-center gap-2 px-8 py-4 bg-dark-blue-500 text-white font-medium rounded-full transition-all duration-300 hover:bg-dark-blue-400 hover:shadow-glow-blue hover:scale-105"
      >
        Ver todos los servicios
        <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 8l4 4m0 0l-4 4m4-4H3" />
        </svg>
      </a>
    </div>
  </div>
</section>

<script>
  import { gsap } from 'gsap';
  import { ScrollTrigger } from 'gsap/ScrollTrigger';
  
  gsap.registerPlugin(ScrollTrigger);
  
  // Dynamically load services from API
  document.addEventListener('DOMContentLoaded', async () => {
    const API_URL = window.location.hostname === 'localhost' 
      ? 'http://localhost:3001/api' 
      : 'https://gemini-backend.fly.dev/api';
    
    const servicesGrid = document.getElementById('services-grid');
    
    const icons: Record<string, string> = {
      code: `<path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M10 20l4-16m4 4l4 4-4 4M6 16l-4-4 4-4" />`,
      mobile: `<path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M12 18h.01M8 21h8a2 2 0 002-2V5a2 2 0 00-2-2H8a2 2 0 00-2 2v14a2 2 0 002 2z" />`,
      software: `<path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />`,
      marketing: `<path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M11 3.055A9.001 9.001 0 1020.945 13H11V3.055z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M20.488 9H15V3.512A9.025 9.025 0 0120.488 9z" />`,
      design: `<path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M7 21a4 4 0 01-4-4V5a2 2 0 012-2h4a2 2 0 012 2v12a4 4 0 01-4 4zm0 0h12a2 2 0 002-2v-4a2 2 0 00-2-2h-2.343M11 7.343l1.657-1.657a2 2 0 012.828 0l2.829 2.829a2 2 0 010 2.828l-8.486 8.485M7 17h.01" />`,
      maintenance: `<path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />`,
    };
    
    const colorClasses: Record<string, { bg: string; border: string; text: string; glow: string; gradient: string }> = {
      cyan: {
        bg: 'bg-cyan-500/10',
        border: 'border-cyan-500/30',
        text: 'text-cyan-400',
        glow: 'group-hover:shadow-[0_0_30px_rgba(0,211,255,0.3)]',
        gradient: 'from-cyan-500/5',
      },
      blue: {
        bg: 'bg-blue-500/10',
        border: 'border-blue-500/30',
        text: 'text-blue-400',
        glow: 'group-hover:shadow-[0_0_30px_rgba(0,55,153,0.3)]',
        gradient: 'from-blue-500/5',
      },
      'dark-blue': {
        bg: 'bg-dark-blue-500/20',
        border: 'border-dark-blue-400/30',
        text: 'text-white',
        glow: 'group-hover:shadow-[0_0_30px_rgba(1,24,61,0.4)]',
        gradient: 'from-dark-blue-500/10',
      },
    };
    
    try {
      const response = await fetch(`${API_URL}/services`);
      const data = await response.json();
      
      if (data.success && data.data && servicesGrid) {
        servicesGrid.innerHTML = data.data.map((service: any, index: number) => {
          const color = service.color || 'cyan';
          const features = Array.isArray(service.features) ? service.features : [];
          const classes = colorClasses[color];
          
          return `
            <article 
              class="service-card group relative flex flex-col p-5 sm:p-8 rounded-2xl sm:rounded-3xl border bg-white/50 backdrop-blur-sm transition-all duration-500 ${classes.border} ${classes.glow} hover:-translate-y-2"
              style="animation-delay: ${index * 100}ms"
            >
              <div class="w-12 h-12 sm:w-14 sm:h-14 rounded-xl sm:rounded-2xl flex items-center justify-center mb-4 sm:mb-6 transition-transform duration-300 group-hover:scale-110 ${classes.bg}">
                <svg fill="none" viewBox="0 0 24 24" stroke="currentColor" class="w-7 h-7 ${classes.text}">
                  ${icons[service.icon] || icons['code']}
                </svg>
              </div>
              
              <h3 class="text-lg sm:text-xl font-montserrat-alt font-medium text-dark-blue-500 mb-3">
                ${service.title}
              </h3>
              
              <p class="text-sm sm:text-base flex-1 text-dark-blue-500/60 mb-4 sm:mb-6 leading-relaxed">
                ${service.description}
              </p>
              
              <ul class="space-y-2 mb-6">
                ${features.map((feature: string) => `
                  <li class="flex items-center gap-2 text-sm text-dark-blue-500/70">
                    <svg class="w-4 h-4 flex-shrink-0 ${classes.text}" fill="currentColor" viewBox="0 0 20 20">
                      <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
                    </svg>
                    ${feature}
                  </li>
                `).join('')}
              </ul>
              
              <a 
                href="/servicios#${service.title.toLowerCase().replace(/\s+/g, '-')}"
                class="inline-flex items-center gap-2 text-sm font-medium transition-all duration-300 ${classes.text} hover:gap-3"
              >
                Conocer más
                <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 8l4 4m0 0l-4 4m4-4H3" />
                </svg>
              </a>
              
              <div class="absolute inset-0 rounded-3xl opacity-0 group-hover:opacity-100 transition-opacity duration-500 -z-10 bg-gradient-to-br ${classes.gradient} to-transparent" />
            </article>
          `;
        }).join('');
        
        // Animate cards
        gsap.utils.toArray('.service-card').forEach((card: any, index: number) => {
          gsap.from(card, {
            opacity: 0,
            y: 60,
            duration: 0.8,
            delay: index * 0.1,
            ease: 'power3.out',
            scrollTrigger: {
              trigger: card,
              start: 'top 85%',
              toggleActions: 'play none none reverse',
            },
          });
        });
      }
    } catch (error) {
      console.error('Error loading services:', error);
    }
  });
</script>
